"""
Electron UGC Bot â€“ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ğ¸Ğ´ĞµĞ¸ / feedback Ğ¸ ÑˆĞ»Ñ‘Ñ‚ Ğ¸Ñ… Ğ² Ğ¼Ğ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ÑĞºĞ¸Ğ¹ Ñ‡Ğ°Ñ‚
aiogram-3
"""

import os
import asyncio
from collections import defaultdict

from aiogram import Bot, Dispatcher, F
from aiogram.enums import ParseMode
from aiogram.client.bot import DefaultBotProperties
from aiogram.types import (
    Message,
    KeyboardButton,
)
from aiogram.utils.keyboard import ReplyKeyboardBuilder

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BOT_TOKEN = os.getenv("BOT_TOKEN")
ADMIN_CHAT_ID = int(os.getenv("ADMIN_CHAT_ID", "0"))

if not BOT_TOKEN or not ADMIN_CHAT_ID:
    raise RuntimeError("ĞÑƒĞ¶Ğ½Ñ‹ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ BOT_TOKEN Ğ¸ ADMIN_CHAT_ID")

bot = Bot(
    BOT_TOKEN,
    default=DefaultBotProperties(parse_mode=ParseMode.HTML)
)
dp = Dispatcher()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def main_menu():
    kb = ReplyKeyboardBuilder()
    kb.add(
    KeyboardButton(text="/idea"),
    KeyboardButton(text="/feedback")
    )
    kb.adjust(2)
    return kb.as_markup(resize_keyboard=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ¿Ñ€Ğ¾ÑÑ‚ĞµĞ¹ÑˆĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
waiting_for = defaultdict(lambda: None)        # user_id â†’ "idea"/"fb"/None

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ñ…ÑĞ½Ğ´Ğ»ĞµÑ€Ñ‹ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@dp.message(F.text == "/start")
async def cmd_start(message: Message):
    waiting_for.pop(message.from_user.id, None)
    await message.answer(
        "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ¯ Ğ±Ğ¾Ñ‚ Ğ­Ğ»ĞµĞºÑ‚Ñ€Ğ¾Ğ½Ğ° â€“ ÑĞ¾Ğ±Ğ¸Ñ€Ğ°Ñ Ğ¸Ğ´ĞµĞ¸ Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½ÑƒÑ ÑĞ²ÑĞ·ÑŒ.\n"
        "ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ /idea Ğ¸Ğ»Ğ¸ /feedback.",
        reply_markup=main_menu(),
    )

@dp.message(F.text == "/idea")
async def cmd_idea(message: Message):
    waiting_for[message.from_user.id] = "idea"
    await message.answer(
        "ĞĞ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ²Ğ°ÑˆÑƒ Ğ¸Ğ´ĞµÑ Ğ¾Ğ´Ğ½Ğ¸Ğ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ĞµĞ¼. ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ĞµÑ‘ ÑƒĞ²Ğ¸Ğ´ÑÑ‚ Ğ¼Ğ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ñ‹ ğŸ“©"
    )

@dp.message(F.text == "/feedback")
async def cmd_feedback(message: Message):
    waiting_for[message.from_user.id] = "fb"
    await message.answer(
        "ĞÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½ÑƒÑ ÑĞ²ÑĞ·ÑŒ Ğ¾Ğ´Ğ½Ğ¸Ğ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ĞµĞ¼ â€“ Ğ¼Ñ‹ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ğŸ™‚"
    )

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ Ğ¾Ğ´Ğ½Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° â”€â”€â”€â”€â”€â”€â”€
@dp.message()
async def catcher(message: Message):
    state = waiting_for.get(message.from_user.id)
    if state is None:       # Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ°
        return
    # Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ñ‡Ğ°Ñ‚Ğ°
    kind = "ğŸ’¡ <b>ĞĞ¾Ğ²Ğ°Ñ Ğ¸Ğ´ĞµÑ</b>" if state == "idea" else "âœ‰ï¸ <b>Feedback</b>"
    text = (
        f"{kind}\n"
        f"<b>ĞÑ‚:</b> {message.from_user.full_name} (<code>{message.from_user.id}</code>)\n"
        f"<b>Ğ¢ĞµĞºÑÑ‚:</b>\n{message.html_text}"
    )
    await bot.send_message(ADMIN_CHAT_ID, text)
    await message.answer("Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾! Ğ’Ğ°ÑˆĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¼Ğ¾Ğ´ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°Ğ¼ ğŸ™Œ")

    waiting_for.pop(message.from_user.id, None)   # ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
